<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MartinezPOS - Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Header (mobile) -->
  <header class="bg-white shadow-md p-4 flex justify-between items-center md:hidden">
    <h1 class="text-xl font-bold text-indigo-600">MartinezPOS Admin</h1>
    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-xl font-medium transition">Logout</button>
  </header>

  <div class="flex flex-1 overflow-hidden">

    <!-- Sidebar desktop -->
    <aside class="hidden md:flex w-64 bg-white shadow-lg flex-col p-6">
      <h1 class="text-2xl font-bold text-indigo-600 mb-6">MartinezPOS Admin</h1>
      <nav class="flex flex-col gap-3">
        <button id="navDashboard" class="text-gray-700 hover:text-indigo-600 font-medium">Dashboard</button>
        <button id="navTransactions" class="text-gray-700 hover:text-indigo-600 font-medium">Transactions</button>
        <button id="logoutBtnDesktop" class="mt-6 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl font-medium transition">Logout</button>
      </nav>
    </aside>

    <!-- Main content -->
    <main class="flex-1 p-4 overflow-auto">

      <!-- Dashboard -->
      <div id="dashboardSection">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Admin Dashboard</h2>
        <p class="mb-4 text-gray-600">Welcome to MartinezPOS Admin Panel.</p>

        <div class="max-w-md mx-auto mb-6">
          <div class="bg-white shadow rounded-xl p-6 flex flex-col items-center">
            <h3 class="text-lg font-semibold text-gray-700">Total Sales Amount</h3>
            <p id="totalSales" class="text-2xl font-bold mt-2">₦0</p>
          </div>
        </div>
      </div>

      <!-- Transactions Page -->
      <div id="transactionsSection" class="hidden">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">All Transactions</h2>

        <div class="max-w-md mx-auto mb-4 flex gap-2">
          <input id="transactionSearch" type="text"
            placeholder="Search by attendant name..."
            class="w-full px-4 py-3 border rounded-xl border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 text-gray-700"/>
          <button id="clearTransactionsBtn"
            class="bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-xl font-semibold transition">
            Clear All
          </button>
        </div>

        <div class="overflow-x-auto bg-white rounded-xl shadow-2xl">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Attendant</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Charge</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
              </tr>
            </thead>
            <tbody id="transactionsTableBody" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>

    </main>
  </div>

<script>

  // =============================
  // AUTH CHECK
  // =============================
  const user_id = localStorage.getItem("user_id");
  const role = localStorage.getItem("role");

  if (!user_id || role !== "admin") {
    alert("Access denied.");
    window.location.href = "login.html";
  }

  // =============================
  // LOGOUT
  // =============================
  ["logoutBtn", "logoutBtnDesktop"].forEach(id => {
    document.getElementById(id)?.addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "login.html";
    });
  });

  const dashboardSection = document.getElementById("dashboardSection");
  const transactionsSection = document.getElementById("transactionsSection");

  document.getElementById("navDashboard").onclick = () => {
    dashboardSection.classList.remove("hidden");
    transactionsSection.classList.add("hidden");
    loadDashboardStats();
  };

  document.getElementById("navTransactions").onclick = () => {
    dashboardSection.classList.add("hidden");
    transactionsSection.classList.remove("hidden");
    loadTransactions();
  };

  // =============================
  // DASHBOARD STATS
  // =============================
  async function loadDashboardStats() {
    try {
      const res = await fetch("/total_sales");
      const data = await res.json();
      document.getElementById("totalSales").innerText = `₦${data.total || 0}`;
    } catch (err) {
      console.error("Failed to fetch stats:", err);
    }
  }

  // =============================
  // LOAD TRANSACTIONS
  // =============================
  let allTransactions = [];

  async function loadTransactions() {
    const tableBody = document.getElementById("transactionsTableBody");
    tableBody.innerHTML = "<tr><td colspan='7' class='text-center p-4'>Loading...</td></tr>";

    try {
      const res = await fetch("/all_transactions");
      const data = await res.json();

      allTransactions = Array.isArray(data) ? data : [];
      renderTransactions(allTransactions);

    } catch (err) {
      console.error("Failed:", err);
      tableBody.innerHTML = "<tr><td colspan='7' class='text-center p-4 text-red-500'>Failed to load transactions</td></tr>";
    }
  }

  function renderTransactions(data) {
    const tableBody = document.getElementById("transactionsTableBody");
    tableBody.innerHTML = "";

    if (!data.length) {
      tableBody.innerHTML = "<tr><td colspan='7' class='text-center p-4'>No transactions found</td></tr>";
      return;
    }

    data.forEach(t => {
      const dt = new Date(t.sales_date || t.created_at);
      const formattedDate = dt.toLocaleDateString();
      const formattedTime = dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="px-4 py-2">${t.id}</td>
        <td class="px-4 py-2">${t.attendant_name || t.username}</td>
        <td class="px-4 py-2">₦${t.amount_withdrawn}</td>
        <td class="px-4 py-2">₦${t.charge}</td>
        <td class="px-4 py-2">${t.transaction_type}</td>
        <td class="px-4 py-2">${formattedDate}</td>
        <td class="px-4 py-2">${formattedTime}</td>
      `;
      tableBody.appendChild(tr);
    });
  }

  // =============================
  // SEARCH
  // =============================
  document.getElementById("transactionSearch").addEventListener("input", e => {
    const val = e.target.value.toLowerCase();
    const filtered = allTransactions.filter(t =>
      (t.attendant_name || t.username).toLowerCase().includes(val)
    );
    renderTransactions(filtered);
  });

  // =============================
  // DELETE ALL
  // =============================
  document.getElementById("clearTransactionsBtn").onclick = async () => {
    if (!confirm("Delete ALL transactions?")) return;

    try {
      const res = await fetch("/delete_all_transactions", { method: "DELETE" });
      const data = await res.json();

      if (res.ok) {
        alert(data.message);
        loadTransactions();
        loadDashboardStats();
      } else {
        alert(data.detail || "Failed to delete.");
      }
    } catch (err) {
      alert("Server unreachable.");
    }
  };

  // =============================
  // INIT
  // =============================
  loadDashboardStats();

</script>

</body>
</html>
