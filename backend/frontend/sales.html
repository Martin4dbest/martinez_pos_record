<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MartinezPOS - Record Transaction</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body style="margin:0; font-family:'Segoe UI',sans-serif; background:#f3f4f6; min-height:100vh; display:flex; flex-direction:column; align-items:center;">

<!-- Navbar -->
<nav style="width:100%; background:white; box-shadow:0 4px 10px rgba(0,0,0,0.1); padding:15px 20px; display:flex; justify-content:space-between; align-items:center; box-sizing:border-box;">
<div>
<h1 style="font-size:20px; font-weight:700; color:#4f46e5;">MartinezPOS - Sales</h1>
<p id="welcomeText" style="font-size:14px; color:#6b7280; margin-top:4px;">Welcome</p>
</div>

<button id="logoutBtn" style="background:#ef4444; color:white; border:none; padding:10px 20px; border-radius:12px; font-weight:600; cursor:pointer;">
Logout
</button>
</nav>

<!-- Transaction Form Card -->
<main style="flex:1; width:100%; display:flex; justify-content:center; align-items:flex-start; margin-top:50px; padding:0 10px; box-sizing:border-box;">
<div style="background:white; padding:40px 30px; border-radius:25px; box-shadow:0 10px 30px rgba(0,0,0,0.15); width:100%; max-width:400px; display:flex; flex-direction:column; align-items:center;">

<h2 style="font-size:26px; font-weight:700; color:#4f46e5; margin-bottom:15px;">Record Transaction</h2>

<form id="transactionForm" style="width:100%; display:flex; flex-direction:column; gap:20px;">

<div style="position:relative;">
<input id="amount_withdrawn" type="number" step="0.01" placeholder="Amount Withdrawn" required
style="width:100%; padding:15px 15px 15px 45px; border-radius:15px; border:1px solid #d1d5db; font-size:16px;">
<span style="position:absolute; left:15px; top:50%; transform:translateY(-50%); color:#9ca3af;">ðŸ’°</span>
</div>

<div style="position:relative;">
<input id="charge" type="number" step="0.01" placeholder="Charge Made" required
style="width:100%; padding:15px 15px 15px 45px; border-radius:15px; border:1px solid #d1d5db; font-size:16px;">
<span style="position:absolute; left:15px; top:50%; transform:translateY(-50%); color:#9ca3af;">ðŸ’µ</span>
</div>

<select id="transaction_type" required
style="width:100%; padding:15px; border-radius:15px; border:1px solid #d1d5db; font-size:16px;">
<option value="">Select Type</option>
<option value="Withdrawal">Withdrawal</option>
<option value="Deposit">Deposit</option>
<option value="Transfer">Transfer</option>
<option value="Airtime">Airtime</option>
<option value="Bill Payment">Bill Payment</option>
</select>

<button id="submitBtn" type="submit"
style="width:100%; padding:15px; border:none; border-radius:15px; background-color:#4f46e5; color:white; font-size:16px; font-weight:600; cursor:pointer;">
<span id="btnText">Submit</span>
<span id="spinner" style="display:none;">Loading...</span>
</button>

</form>

<p id="feedback" style="margin-top:20px; font-size:14px; text-align:center; display:none;"></p>

</div>
</main>

<script>
/* FIX #1: Proper keyframes syntax */
const style = document.createElement('style');
style.innerHTML = `
@keyframes spin {
  to { transform: rotate(360deg); }
}`;
document.head.appendChild(style);

/* Logout */
document.getElementById("logoutBtn").onclick = () => {
  localStorage.clear();
  window.location.href = "/";
};

/* Check user */
const user_id = localStorage.getItem("user_id");
const role = localStorage.getItem("role");
const username = localStorage.getItem("username");

if (!user_id || role === "admin") {
  alert("Access denied. Only attendants can access this page.");
  window.location.href = "login.html";
}

/* FIX #2: Backticks added */
document.getElementById("welcomeText").innerText = 
`Welcome, ${username || "Attendant"}`;

const form = document.getElementById("transactionForm");
const feedback = document.getElementById("feedback");
const submitBtn = document.getElementById("submitBtn");
const btnText = document.getElementById("btnText");
const spinner = document.getElementById("spinner");

form.onsubmit = async (e) => {
  e.preventDefault();

  btnText.style.display = "none";
  spinner.style.display = "inline";
  submitBtn.disabled = true;

  const amount = parseFloat(document.getElementById("amount_withdrawn").value);
  const charge = parseFloat(document.getElementById("charge").value);
  const transaction_type = document.getElementById("transaction_type").value;

  try {
    const res = await fetch("/transactions", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: parseInt(user_id),
        amount_withdrawn: amount,
        charge: charge,
        transaction_type: transaction_type
      })
    });

    const data = await res.json();

    if (res.ok) {
      feedback.innerText = data.message;
      feedback.style.color = "green";
      feedback.style.display = "block";
      form.reset();
    } else {
      feedback.innerText = data.detail || "Failed to log transaction";
      feedback.style.color = "red";
      feedback.style.display = "block";
    }

  } catch (err) {
    feedback.innerText = "Server unreachable. Make sure backend is running.";
    feedback.style.color = "red";
    feedback.style.display = "block";
  }

  btnText.style.display = "inline";
  spinner.style.display = "none";
  submitBtn.disabled = false;
};
</script>

</body>
</html>
